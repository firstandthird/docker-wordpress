#!/bin/bash

#test if the service is up
SERVICE_ADDR=mysql
SERVICE_PORT=3306
CONN_STATUS="DOWN"
COUNTER=0
while [ "$CONN_STATUS" == "DOWN" -a $COUNTER -lt 4 ]
do
  CONN_STATUS=`(echo > /dev/tcp/$SERVICE_ADDR/$SERVICE_PORT) >/dev/null 2>&1 && echo "UP" || echo "DOWN"`
  echo -e "\t SERVICE connection status: $CONN_STATUS"
  echo -e "\t waiting 5s for Service connetion..."
  sleep 5
  let COUNTER=COUNTER+1
done

SKIPSALT=false
CONFIG=$(cat <<PHP
define( 'DISALLOW_FILE_EDIT', true );
define( 'WP_CONTENT_DIR', \$_SERVER['DOCUMENT_ROOT'] . '/wp-content' );
define( 'WP_PLUGIN_DIR', \$_SERVER['DOCUMENT_ROOT'] . '/wp-content/plugins' );
define( 'PLUGINDIR', \$_SERVER['DOCUMENT_ROOT'] . '/wp-content/plugins' );

define( 'WP_SITEURL', 'http://' . \$_SERVER['HTTP_HOST'] . '/');
define( 'WP_HOME',    'http://' . \$_SERVER['HTTP_HOST'] . '/');
define( 'WP_CONTENT_URL', 'http://' . \$_SERVER['HTTP_HOST'] . '/wp-content');
define( 'WP_PLUGIN_URL',  'http://' . \$_SERVER['HTTP_HOST'] . '/wp-content/plugins');
define( 'UPLOADS',  'wp-content/uploads' );
PHP
)

if [[ -n "$AUTH_SALT" ]]; then
  echo "Using salt from env vars"
  SKIPSALT=true
  CONFIG=$(cat <<PHP
$CONFIG
define( 'AUTH_KEY',         "$AUTH_KEY");
define( 'SECURE_AUTH_KEY',  "$SECURE_AUTH_KEY");
define( 'LOGGED_IN_KEY',    "$LOGGED_IN_KEY");
define( 'NONCE_KEY',        "$NONCE_KEY");
define( 'AUTH_SALT',        "$AUTH_SALT");
define( 'SECURE_AUTH_SALT', "$SECURE_AUTH_SALT");
define( 'LOGGED_IN_SALT',   "$LOGGED_IN_SALT");
define( 'NONCE_SALT',       "$NONCE_SALT");
PHP
)
fi

#reset wp-config.php
rm -f wp-config.php
wp --allow-root core config \
  --dbhost=mysql \
  --dbname=$DBNAME \
  --dbuser=$DBUSER \
  --dbpass=$DBPASS \
  --skip-salts=$SKIPSALT \
  --extra-php <<PHP
$CONFIG
PHP

if ! $(wp --allow-root core is-installed); then
  echo "creating database"
  wp --allow-root db create
  echo "installing wordpress..."
  wp --allow-root core install \
    --url="$WORDPRESS_URL" \
    --title=InspirED \
    --admin_email="$WORDPRESS_ADMIN_EMAIL" \
    --admin_name="$WORDPRESS_ADMIN_NAME" \
    --admin_password="$WORDPRESS_ADMIN_PASS"
fi

if [[ -n "$THEME" ]]; then
  wp --allow-root theme activate $THEME
fi
wp --allow-root rewrite structure '/%postname%/'

if [[ -f "/setup-after" ]]; then
  bash /setup-after
fi

exec $@
